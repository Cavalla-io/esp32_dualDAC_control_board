//    FILE: MCP4921_dual_memorysafe.ino
//  AUTHOR: Mohammad Nafisi
// PURPOSE: Memory-safe control of two MCP4921 DACs
//     URL: https://github.com/RobTillaart/MCP_DAC

#include "SPI.h"

#define MCP4921_CS1_PIN  5  // Chip Select for DAC 1
#define MCP4921_CS2_PIN  4  // Chip Select for DAC 2

float voltage1 = 3.4;
float voltage2 = 1.4;

void setup()
{
  Serial.begin(9600);
  Serial.println("ESP32 MCP4921 Dual DAC Control");

  pinMode(MCP4921_CS1_PIN, OUTPUT);
  pinMode(MCP4921_CS2_PIN, OUTPUT);
  digitalWrite(MCP4921_CS1_PIN, HIGH);
  digitalWrite(MCP4921_CS2_PIN, HIGH);

  SPI.begin(18, -1, 23, -1);  // Initialize VSPI

  // Set DAC1 to 1.4V and DAC2 to 3.4V
  setDACVoltage(MCP4921_CS1_PIN, voltage1);
  setDACVoltage(MCP4921_CS2_PIN, voltage2);
}

void setDACVoltage(uint8_t csPin, float voltage)
{
  if (voltage < 0.0 || voltage > 5.0) return;  // Ensure valid range
  uint16_t value = (voltage / 5.0) * 4095;
  uint16_t data = 0x3000 | value;
  
  digitalWrite(csPin, LOW);
  SPI.beginTransaction(SPISettings(1000000, MSBFIRST, SPI_MODE0));  // 1 MHz SPI
  SPI.transfer((uint8_t)(data >> 8));
  SPI.transfer((uint8_t)(data & 0xFF));
  SPI.endTransaction();
  digitalWrite(csPin, HIGH);
}

void loop()
{
  Serial.print("DAC1 Voltage: ");
  Serial.print(voltage1);
  Serial.print("V, DAC2 Voltage: ");
  Serial.print(voltage2);
  Serial.println("V");

  if (voltage1 < 4.5 && voltage2 < 4.5) {
    voltage1 += 0.01;
    voltage2 += 0.01;
    setDACVoltage(MCP4921_CS1_PIN, voltage1);
    setDACVoltage(MCP4921_CS2_PIN, voltage2);
  }

  delay(100);  // Small delay for stability
}
